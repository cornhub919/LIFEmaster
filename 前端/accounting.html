<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeMaster - 记账</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5E3B12',
                        secondary: '#8B5A2B',
                        neutral: '#F5F5DC',
                        accent: '#A0522D',
                        income: '#4CAF50',
                        expense: '#FF4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .record-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            .slide-up {
                animation: slideUp 0.3s ease-out;
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(94, 59, 18, 0.4); }
                70% { box-shadow: 0 0 0 10px rgba(94, 59, 18, 0); }
                100% { box-shadow: 0 0 0 0 rgba(94, 59, 18, 0); }
            }
            .circle-currency {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                width: 1.5em;
                height: 1.5em;
                border-radius: 50%;
                background-color: theme('colors.primary');
                color: white;
                font-weight: bold;
                margin-right: 0.5em;
            }
        }
    </style>
</head>
<body class="bg-neutral min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 顶部导航 -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-primary">
                    <span class="circle-currency">¥</span>生活记账
                </h1>
                <button id="back-btn" class="text-primary hover:text-accent transition-colors duration-300">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
            </div>
            <p class="text-gray-600 mt-2">记录每一笔收支，掌握财务状况</p>
        </header>

        <!-- 添加新记录区域 -->
        <div class="bg-white rounded-lg p-5 mb-8 shadow-lg slide-up">
            <h2 class="text-xl font-semibold text-primary mb-4">添加新记录</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">类型</label>
                    <div class="flex">
                        <button id="income-btn" class="flex-1 py-2 px-4 bg-income text-white rounded-l-lg transition-all duration-300">
                            <i class="fa-solid fa-arrow-down mr-1"></i> 收入
                        </button>
                        <button id="expense-btn" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-r-lg transition-all duration-300">
                            <i class="fa-solid fa-arrow-up mr-1"></i> 支出
                        </button>
                    </div>
                </div>
                
                <div class="md:col-span-2">
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                            <select id="category-select" class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                <option value="">请选择分类</option>
                                <!-- 分类选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                        <button id="add-category-btn" class="mt-5 px-4 py-2 bg-primary text-white rounded-lg transition-all duration-300 flex items-center justify-center">
                            <i class="fa-solid fa-plus mr-1"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">金额</label>
                    <input type="number" id="amount-input" placeholder="0.00" step="0.01" min="0" 
                        class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                    <input type="date" id="date-input" 
                        class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">备注（可选）</label>
                    <input type="text" id="note-input" placeholder="添加备注..." 
                        class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                </div>
                
                <button id="add-record-btn" class="md:col-span-2 bg-primary hover:bg-accent text-white font-medium px-6 py-3 rounded-lg transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-plus mr-2"></i>添加记录
                </button>
            </div>
        </div>

        <!-- 分类管理模态框 -->
        <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden fade-in">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl slide-up">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-primary">管理分类</h3>
                    <button id="close-category-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">添加新分类</label>
                    <div class="flex gap-2">
                        <input type="text" id="new-category-input" placeholder="输入分类名称" 
                            class="flex-1 py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                        <select id="new-category-type" class="py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                            <option value="income">收入</option>
                            <option value="expense">支出</option>
                        </select>
                        <button id="confirm-add-category" class="px-4 py-2 bg-primary text-white rounded-lg transition-all duration-300">
                            添加
                        </button>
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-2">收入分类</h4>
                    <ul id="income-categories" class="space-y-2 mb-4">
                        <!-- 收入分类将通过JavaScript动态生成 -->
                    </ul>
                    
                    <h4 class="font-medium text-gray-700 mb-2">支出分类</h4>
                    <ul id="expense-categories" class="space-y-2">
                        <!-- 支出分类将通过JavaScript动态生成 -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- 统计概览 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-lg p-5 shadow-lg fade-in">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm">本月收入</p>
                        <h3 class="text-2xl font-bold text-income mt-1" id="month-income">¥0.00</h3>
                    </div>
                    <div class="bg-income/10 p-2 rounded-full">
                        <i class="fa-solid fa-arrow-down text-income"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-5 shadow-lg fade-in">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm">本月支出</p>
                        <h3 class="text-2xl font-bold text-expense mt-1" id="month-expense">¥0.00</h3>
                    </div>
                    <div class="bg-expense/10 p-2 rounded-full">
                        <i class="fa-solid fa-arrow-up text-expense"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-5 shadow-lg fade-in">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm">本月结余</p>
                        <h3 class="text-2xl font-bold text-primary mt-1" id="month-balance">¥0.00</h3>
                    </div>
                    <div class="bg-primary/10 p-2 rounded-full">
                        <i class="fa-solid fa-balance-scale text-primary"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg p-5 shadow-lg fade-in">
                <h3 class="text-lg font-semibold text-primary mb-4 flex items-center">
                    <i class="fa-solid fa-arrow-down text-income mr-2"></i> 收入分类占比
                </h3>
                <div class="h-64">
                    <div id="income-chart" class="w-full h-full"></div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-5 shadow-lg fade-in">
                <h3 class="text-lg font-semibold text-primary mb-4 flex items-center">
                    <i class="fa-solid fa-arrow-up text-expense mr-2"></i> 支出分类占比
                </h3>
                <div class="h-64">
                    <div id="expense-chart" class="w-full h-full"></div>
                </div>
            </div>
        </div>

        <!-- 最近记录 -->
        <div class="bg-white rounded-lg p-5 shadow-lg fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-primary">最近记录</h2>
                <div class="flex gap-2">
                    <button id="filter-all-records" class="filter-btn bg-primary text-white px-4 py-2 rounded-lg">全部</button>
                    <button id="filter-income" class="filter-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">收入</button>
                    <button id="filter-expense" class="filter-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">支出</button>
                </div>
            </div>
            
            <!-- 记录列表 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="records-table" class="bg-white divide-y divide-gray-200">
                        <!-- 记录会通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 空状态 -->
            <div id="empty-records" class="py-12 text-center hidden">
                <i class="fa-solid fa-file-invoice text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">暂无记录</p>
                <p class="text-gray-400 text-sm mt-2">添加一笔收支开始记录吧</p>
            </div>
        </div>
    </div>

    <!-- 编辑记录模态框 -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden fade-in">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl slide-up">
            <h3 class="text-xl font-semibold text-primary mb-4">编辑记录</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">类型</label>
                    <div class="flex">
                        <button id="edit-income-btn" class="flex-1 py-2 px-4 bg-income text-white rounded-l-lg transition-all duration-300">
                            <i class="fa-solid fa-arrow-down mr-1"></i> 收入
                        </button>
                        <button id="edit-expense-btn" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-r-lg transition-all duration-300">
                            <i class="fa-solid fa-arrow-up mr-1"></i> 支出
                        </button>
                    </div>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                    <select id="edit-category-select" class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                        <!-- 分类选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">金额</label>
                    <input type="number" id="edit-amount-input" placeholder="0.00" step="0.01" min="0" 
                        class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                    <input type="date" id="edit-date-input" 
                        class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">备注（可选）</label>
                    <input type="text" id="edit-note-input" placeholder="添加备注..." 
                        class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-edit-btn" class="px-5 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">取消</button>
                <button id="save-edit-btn" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-accent transition-colors">保存</button>
            </div>
        </div>
    </div>

    <!-- 提示框 -->
    <div id="toast" class="fixed bottom-4 right-4 bg-primary text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-16 opacity-0 transition-all duration-500 z-50"></div>

    <script>
        // 记录数据
        let records = [];
        let categories = {
            income: [
                { id: 'salary', name: '工资', color: '#4CAF50' },
                { id: 'bonus', name: '奖金', color: '#8BC34A' },
                { id: 'investment', name: '投资', color: '#CDDC39' }
            ],
            expense: [
                { id: 'food', name: '餐饮', color: '#FF4444' },
                { id: 'transport', name: '交通', color: '#FF9800' },
                { id: 'shopping', name: '购物', color: '#FFC107' },
                { id: 'housing', name: '住房', color: '#FF5722' },
                { id: 'entertainment', name: '娱乐', color: '#F44336' }
            ]
        };
        let currentEditingRecordId = null;
        let currentRecordFilter = 'all';
        let currentRecordType = 'income';
        let incomeChart, expenseChart;
        
        // DOM 元素
        const incomeBtn = document.getElementById('income-btn');
        const expenseBtn = document.getElementById('expense-btn');
        const categorySelect = document.getElementById('category-select');
        const amountInput = document.getElementById('amount-input');
        const dateInput = document.getElementById('date-input');
        const noteInput = document.getElementById('note-input');
        const addRecordBtn = document.getElementById('add-record-btn');
        const recordsTable = document.getElementById('records-table');
        const emptyRecords = document.getElementById('empty-records');
        const editModal = document.getElementById('edit-modal');
        const editIncomeBtn = document.getElementById('edit-income-btn');
        const editExpenseBtn = document.getElementById('edit-expense-btn');
        const editCategorySelect = document.getElementById('edit-category-select');
        const editAmountInput = document.getElementById('edit-amount-input');
        const editDateInput = document.getElementById('edit-date-input');
        const editNoteInput = document.getElementById('edit-note-input');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const toast = document.getElementById('toast');
        const backBtn = document.getElementById('back-btn');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const monthIncomeElement = document.getElementById('month-income');
        const monthExpenseElement = document.getElementById('month-expense');
        const monthBalanceElement = document.getElementById('month-balance');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoryModal = document.getElementById('category-modal');
        const closeCategoryModal = document.getElementById('close-category-modal');
        const newCategoryInput = document.getElementById('new-category-input');
        const newCategoryType = document.getElementById('new-category-type');
        const confirmAddCategory = document.getElementById('confirm-add-category');
        const incomeCategoriesList = document.getElementById('income-categories');
        const expenseCategoriesList = document.getElementById('expense-categories');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 加载本地存储的数据
            loadData();
            
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            
            // 初始化图表
            initCharts();
            
            // 渲染分类选择器
            renderCategorySelectors();
            
            // 渲染分类列表
            renderCategoryLists();
            
            // 渲染记录
            renderRecords();
            updateStatistics();
            
            // 事件监听
            incomeBtn.addEventListener('click', () => setRecordType('income'));
            expenseBtn.addEventListener('click', () => setRecordType('expense'));
            editIncomeBtn.addEventListener('click', () => setEditRecordType('income'));
            editExpenseBtn.addEventListener('click', () => setEditRecordType('expense'));
            addRecordBtn.addEventListener('click', addRecord);
            backBtn.addEventListener('click', () => window.history.back());
            addCategoryBtn.addEventListener('click', () => categoryModal.classList.remove('hidden'));
            closeCategoryModal.addEventListener('click', () => categoryModal.classList.add('hidden'));
            confirmAddCategory.addEventListener('click', addNewCategory);
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentRecordFilter = e.target.id.replace('filter-', '').replace('records', '');
                    updateFilterButtons();
                    renderRecords();
                });
            });
            
            // 为动态添加的元素添加事件委托
            recordsTable.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-record-btn');
                if (editBtn) {
                    const recordId = parseInt(editBtn.closest('tr').dataset.id);
                    startEditing(recordId);
                }
                
                const deleteBtn = e.target.closest('.delete-record-btn');
                if (deleteBtn) {
                    const recordId = parseInt(deleteBtn.closest('tr').dataset.id);
                    deleteRecord(recordId);
                }
            });
            
            // 监听窗口大小变化，重新渲染图表
            window.addEventListener('resize', () => {
                if (incomeChart) incomeChart.resize();
                if (expenseChart) expenseChart.resize();
            });
        });
        
        // 从本地存储加载数据
        function loadData() {
            const savedRecords = localStorage.getItem('accountingRecords');
            if (savedRecords) {
                records = JSON.parse(savedRecords);
            }
            
            const savedCategories = localStorage.getItem('accountingCategories');
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
            }
        }
        
        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('accountingRecords', JSON.stringify(records));
            localStorage.setItem('accountingCategories', JSON.stringify(categories));
        }
        
        // 设置记录类型
        function setRecordType(type) {
            currentRecordType = type;
            
            if (type === 'income') {
                incomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.add('bg-income', 'text-white');
                expenseBtn.classList.remove('bg-expense', 'text-white');
                expenseBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                expenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.add('bg-expense', 'text-white');
                incomeBtn.classList.remove('bg-income', 'text-white');
                incomeBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
            
            // 过滤分类选项
            filterCategoryOptions(type, categorySelect);
        }
        
        // 设置编辑记录类型
        function setEditRecordType(type) {
            if (type === 'income') {
                editIncomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                editIncomeBtn.classList.add('bg-income', 'text-white');
                editExpenseBtn.classList.remove('bg-expense', 'text-white');
                editExpenseBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                editExpenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                editExpenseBtn.classList.add('bg-expense', 'text-white');
                editIncomeBtn.classList.remove('bg-income', 'text-white');
                editIncomeBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
            
            // 过滤分类选项
            filterCategoryOptions(type, editCategorySelect);
        }
        
        // 过滤分类选项
        function filterCategoryOptions(type, selectElement) {
            const options = selectElement.options;
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value) {
                    const categoryType = getCategoryType(option.value);
                    option.style.display = categoryType === type ? '' : 'none';
                    
                    // 如果当前选中的选项被隐藏，则清空选择
                    if (option.selected && option.style.display === 'none') {
                        selectElement.value = '';
                    }
                }
            }
        }
        
        // 获取分类类型
        function getCategoryType(categoryId) {
            if (categories.income.some(cat => cat.id === categoryId)) {
                return 'income';
            }
            if (categories.expense.some(cat => cat.id === categoryId)) {
                return 'expense';
            }
            return null;
        }
        
        // 获取分类信息
        function getCategoryInfo(categoryId) {
            const incomeCat = categories.income.find(cat => cat.id === categoryId);
            if (incomeCat) return incomeCat;
            
            const expenseCat = categories.expense.find(cat => cat.id === categoryId);
            if (expenseCat) return expenseCat;
            
            return { id: categoryId, name: categoryId, color: '#cccccc' };
        }
        
        // 添加新记录
        function addRecord() {
            const category = categorySelect.value;
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;
            const note = noteInput.value.trim();
            
            if (!category) {
                showToast('请选择分类', 'error');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                showToast('请输入有效的金额', 'error');
                return;
            }
            
            if (!date) {
                showToast('请选择日期', 'error');
                return;
            }
            
            const newRecord = {
                id: Date.now(),
                type: currentRecordType,
                category: category,
                amount: amount,
                date: date,
                note: note
            };
            
            records.unshift(newRecord);
            saveData();
            renderRecords();
            updateStatistics();
            updateCharts();
            
            // 重置表单
            amountInput.value = '';
            noteInput.value = '';
            amountInput.focus();
            
            showToast('记录已添加', 'success');
        }
        
        // 添加新分类
        function addNewCategory() {
            const categoryName = newCategoryInput.value.trim();
            const categoryType = newCategoryType.value;
            
            if (!categoryName) {
                showToast('请输入分类名称', 'error');
                return;
            }
            
            // 检查是否已存在同名分类
            const allCategories = [...categories.income, ...categories.expense];
            if (allCategories.some(cat => cat.name.toLowerCase() === categoryName.toLowerCase())) {
                showToast('该分类已存在', 'error');
                return;
            }
            
            // 生成唯一ID
            const categoryId = 'custom_' + Date.now();
            
            // 为新分类分配颜色
            const colors = {
                income: ['#4CAF50', '#8BC34A', '#CDDC39', '#66BB6A', '#9CCC65'],
                expense: ['#FF4444', '#FF9800', '#FFC107', '#FF5722', '#F44336']
            };
            
            // 选择最不常用的颜色
            const usedColors = categories[categoryType].map(cat => cat.color);
            let newColor;
            
            for (const color of colors[categoryType]) {
                if (!usedColors.includes(color)) {
                    newColor = color;
                    break;
                }
            }
            
            if (!newColor) {
                // 如果所有颜色都已使用，则随机选择一个
                newColor = colors[categoryType][Math.floor(Math.random() * colors[categoryType].length)];
            }
            
            // 添加新分类
            categories[categoryType].push({
                id: categoryId,
                name: categoryName,
                color: newColor
            });
            
            // 保存数据并更新UI
            saveData();
            renderCategorySelectors();
            renderCategoryLists();
            
            // 清空输入并关闭模态框
            newCategoryInput.value = '';
            categoryModal.classList.add('hidden');
            
            showToast('分类已添加', 'success');
        }
        
        // 渲染分类选择器
        function renderCategorySelectors() {
            // 清空现有选项
            categorySelect.innerHTML = '<option value="">请选择分类</option>';
            editCategorySelect.innerHTML = '<option value="">请选择分类</option>';
            
            // 添加收入分类
            categories.income.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                option.setAttribute('data-type', 'income');
                categorySelect.appendChild(option.cloneNode(true));
                editCategorySelect.appendChild(option);
            });
            
            // 添加支出分类
            categories.expense.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                option.setAttribute('data-type', 'expense');
                categorySelect.appendChild(option.cloneNode(true));
                editCategorySelect.appendChild(option);
            });
            
            // 应用当前类型的筛选
            filterCategoryOptions(currentRecordType, categorySelect);
            filterCategoryOptions(editIncomeBtn.classList.contains('bg-income') ? 'income' : 'expense', editCategorySelect);
        }
        
        // 渲染分类列表
        function renderCategoryLists() {
            // 清空现有列表
            incomeCategoriesList.innerHTML = '';
            expenseCategoriesList.innerHTML = '';
            
            // 渲染收入分类
            categories.income.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between';
                li.innerHTML = `
                    <span class="flex items-center">
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${cat.color}"></span>
                        ${cat.name}
                    </span>
                    <button class="text-gray-400 hover:text-accent transition-colors delete-category-btn" data-id="${cat.id}" data-type="income">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                incomeCategoriesList.appendChild(li);
            });
            
            // 渲染支出分类
            categories.expense.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between';
                li.innerHTML = `
                    <span class="flex items-center">
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${cat.color}"></span>
                        ${cat.name}
                    </span>
                    <button class="text-gray-400 hover:text-accent transition-colors delete-category-btn" data-id="${cat.id}" data-type="expense">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                expenseCategoriesList.appendChild(li);
            });
            
            // 添加删除分类事件监听
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-id');
                    const categoryType = this.getAttribute('data-type');
                    
                    // 检查是否有记录使用此分类
                    if (records.some(record => record.category === categoryId)) {
                        showToast('此分类正在被使用，无法删除', 'error');
                        return;
                    }
                    
                    // 确认删除
                    if (confirm('确定要删除这个分类吗？')) {
                        categories[categoryType] = categories[categoryType].filter(cat => cat.id !== categoryId);
                        saveData();
                        renderCategorySelectors();
                        renderCategoryLists();
                        showToast('分类已删除', 'success');
                    }
                });
            });
        }
        
        // 渲染记录列表
        function renderRecords() {
            let filteredRecords = [...records];
            
            if (currentRecordFilter === 'income') {
                filteredRecords = filteredRecords.filter(record => record.type === 'income');
            } else if (currentRecordFilter === 'expense') {
                filteredRecords = filteredRecords.filter(record => record.type === 'expense');
            }
            
            recordsTable.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                emptyRecords.classList.remove('hidden');
            } else {
                emptyRecords.classList.add('hidden');
                
                filteredRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors duration-150';
                    row.dataset.id = record.id;
                    
                    const categoryInfo = getCategoryInfo(record.category);
                    const amountClass = record.type === 'income' ? 'text-income' : 'text-expense';
                    const amountSign = record.type === 'income' ? '+' : '-';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${formatDate(record.date)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 text-xs rounded-full ${record.type === 'income' ? 'bg-income/10 text-income' : 'bg-expense/10 text-expense'}">
                                <span class="inline-block w-2 h-2 rounded-full mr-1" style="background-color: ${categoryInfo.color}"></span>
                                ${categoryInfo.name}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            ${record.note || '-'}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${amountClass} text-right">
                            ${amountSign}¥${record.amount.toFixed(2)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-record-btn text-secondary hover:text-primary transition-colors mr-3" title="编辑">
                                <i class="fa-solid fa-pencil"></i>
                            </button>
                            <button class="delete-record-btn text-accent hover:text-primary transition-colors" title="删除">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    recordsTable.appendChild(row);
                });
            }
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }
        
        // 开始编辑记录
        function startEditing(id) {
            const record = records.find(record => record.id === id);
            if (!record) return;
            
            currentEditingRecordId = id;
            
            // 设置表单值
            setEditRecordType(record.type);
            editCategorySelect.value = record.category;
            editAmountInput.value = record.amount;
            editDateInput.value = record.date;
            editNoteInput.value = record.note || '';
            
            // 显示模态框
            editModal.classList.remove('hidden');
            editAmountInput.focus();
        }
        
        // 保存编辑
        function saveEdit() {
            if (currentEditingRecordId === null) return;
            
            const category = editCategorySelect.value;
            const amount = parseFloat(editAmountInput.value);
            const date = editDateInput.value;
            const note = editNoteInput.value.trim();
            
            if (!category) {
                showToast('请选择分类', 'error');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                showToast('请输入有效的金额', 'error');
                return;
            }
            
            if (!date) {
                showToast('请选择日期', 'error');
                return;
            }
            
            const recordType = editIncomeBtn.classList.contains('bg-income') ? 'income' : 'expense';
            
            // 更新记录
            records = records.map(record => {
                if (record.id === currentEditingRecordId) {
                    return {
                        ...record,
                        type: recordType,
                        category: category,
                        amount: amount,
                        date: date,
                        note: note
                    };
                }
                return record;
            });
            
            saveData();
            renderRecords();
            updateStatistics();
            updateCharts();
            closeEditModal();
            
            showToast('记录已更新', 'success');
        }
        
        // 关闭编辑模态框
        function closeEditModal() {
            editModal.classList.add('hidden');
            currentEditingRecordId = null;
        }
        
        // 删除记录
        function deleteRecord(id) {
            if (confirm('确定要删除这条记录吗？')) {
                records = records.filter(record => record.id !== id);
                saveData();
                renderRecords();
                updateStatistics();
                updateCharts();
                
                showToast('记录已删除', 'success');
            }
        }
        
        // 显示提示框
        function showToast(message, type = 'info') {
            toast.textContent = message;
            
            // 设置不同类型的样式
            if (type === 'success') {
                toast.classList.add('bg-green-600');
                toast.classList.remove('bg-primary', 'bg-red-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
                toast.classList.remove('bg-primary', 'bg-green-600');
            } else {
                toast.classList.add('bg-primary');
                toast.classList.remove('bg-green-600', 'bg-red-500');
            }
            
            // 显示提示框
            toast.classList.remove('translate-y-16', 'opacity-0');
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('translate-y-16', 'opacity-0');
            }, 3000);
        }
        
        // 更新筛选按钮状态
        function updateFilterButtons() {
            filterButtons.forEach(btn => {
                const filter = btn.id.replace('filter-', '').replace('records', '');
                if (filter === currentRecordFilter) {
                    btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
        }
        
        // 更新统计信息
        function updateStatistics() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
            });
            
            const income = monthlyRecords
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const expense = monthlyRecords
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const balance = income - expense;
            
            monthIncomeElement.textContent = `¥${income.toFixed(2)}`;
            monthExpenseElement.textContent = `¥${expense.toFixed(2)}`;
            monthBalanceElement.textContent = `¥${balance.toFixed(2)}`;
            
            // 设置结余颜色
            if (balance > 0) {
                monthBalanceElement.classList.remove('text-expense');
                monthBalanceElement.classList.add('text-income');
            } else if (balance < 0) {
                monthBalanceElement.classList.remove('text-income');
                monthBalanceElement.classList.add('text-expense');
            } else {
                monthBalanceElement.classList.remove('text-income', 'text-expense');
                monthBalanceElement.classList.add('text-primary');
            }
        }
        
        // 初始化图表
        function initCharts() {
            // 收入饼图
            const incomeChartEl = document.getElementById('income-chart');
            incomeChart = echarts.init(incomeChartEl);
            
            // 支出饼图
            const expenseChartEl = document.getElementById('expense-chart');
            expenseChart = echarts.init(expenseChartEl);
            
            // 初始更新图表数据
            updateCharts();
        }
        
        // 更新图表数据
        function updateCharts() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
            });
            
            // 按分类统计收入
            const incomeByCategory = {};
            monthlyRecords
                .filter(record => record.type === 'income')
                .forEach(record => {
                    if (!incomeByCategory[record.category]) {
                        incomeByCategory[record.category] = 0;
                    }
                    incomeByCategory[record.category] += record.amount;
                });
            
            // 按分类统计支出
            const expenseByCategory = {};
            monthlyRecords
                .filter(record => record.type === 'expense')
                .forEach(record => {
                    if (!expenseByCategory[record.category]) {
                        expenseByCategory[record.category] = 0;
                    }
                    expenseByCategory[record.category] += record.amount;
                });
            
            // 转换为图表数据格式
            const incomeData = Object.keys(incomeByCategory).map(category => {
                const categoryInfo = getCategoryInfo(category);
                return {
                    value: incomeByCategory[category],
                    name: categoryInfo.name,
                    itemStyle: {
                        color: categoryInfo.color
                    }
                };
            });
            
            const expenseData = Object.keys(expenseByCategory).map(category => {
                const categoryInfo = getCategoryInfo(category);
                return {
                    value: expenseByCategory[category],
                    name: categoryInfo.name,
                    itemStyle: {
                        color: categoryInfo.color
                    }
                };
            });
            
            // 设置收入图表选项
            const incomeOptions = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: ¥{c} ({d}%)'
                },
                legend: {
                    type: 'scroll',
                    orient: 'vertical',
                    right: 10,
                    top: 20,
                    bottom: 20,
                    textStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: '收入分布',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        label: {
                            show: true,
                            formatter: '{b}: {d}%'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: true
                        },
                        data: incomeData.length > 0 ? incomeData : [{value: 1, name: '暂无数据', itemStyle: {color: '#cccccc'}}]
                    }
                ]
            };
            
            // 设置支出图表选项
            const expenseOptions = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: ¥{c} ({d}%)'
                },
                legend: {
                    type: 'scroll',
                    orient: 'vertical',
                    right: 10,
                    top: 20,
                    bottom: 20,
                    textStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: '支出分布',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        label: {
                            show: true,
                            formatter: '{b}: {d}%'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: true
                        },
                        data: expenseData.length > 0 ? expenseData : [{value: 1, name: '暂无数据', itemStyle: {color: '#cccccc'}}]
                    }
                ]
            };
            
            // 更新图表
            incomeChart.setOption(incomeOptions);
            expenseChart.setOption(expenseOptions);
        }
        
        // 事件监听
        saveEditBtn.addEventListener('click', saveEdit);
        cancelEditBtn.addEventListener('click', closeEditModal);
        editAmountInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveEdit();
        });
        editAmountInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeEditModal();
        });
    </script>
</body>
</html>    